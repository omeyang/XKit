name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  GO_VERSION: '1.25.x'
  GOLANGCI_LINT_VERSION: 'v2.8.0'

jobs:
  # ==================== 代码质量检查 ====================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false  # 由 golangci-lint-action 管理缓存

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m

      - name: Check go mod tidy
        run: |
          go mod tidy -diff
          if [ $? -ne 0 ]; then
            echo "::error::go mod tidy 检查失败，请运行 'go mod tidy' 并提交更改"
            exit 1
          fi

  # ==================== 单元测试 ====================
  test:
    name: Test (Go ${{ matrix.go }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go: ['1.24.x', '1.25.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        if: matrix.go == '1.25.x'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unit
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ==================== 构建验证 ====================
  build:
    name: Build (Go ${{ matrix.go }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go: ['1.24.x', '1.25.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Verify dependencies
        run: go mod verify

      - name: Build
        run: go build -v ./...

  # ==================== 安全扫描 ====================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  # ==================== 集成测试 ====================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    # 仅在 main 分支或手动触发时运行（集成测试耗时较长）
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    services:
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongo:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      clickhouse:
        image: clickhouse/clickhouse-server:23.12
        ports:
          - 9000:9000
          - 8123:8123
        env:
          CLICKHOUSE_USER: default
          CLICKHOUSE_PASSWORD: ''
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: '1'
        options: >-
          --health-cmd "wget -qO- http://localhost:8123/ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      etcd:
        image: quay.io/coreos/etcd:v3.5.17
        ports:
          - 2379:2379
        env:
          ETCD_NAME: etcd0
          ETCD_ADVERTISE_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_INITIAL_ADVERTISE_PEER_URLS: http://0.0.0.0:2380
          ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
          ETCD_INITIAL_CLUSTER: etcd0=http://0.0.0.0:2380
        options: >-
          --health-cmd "etcdctl endpoint health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Kafka (KRaft 模式)
      kafka:
        image: apache/kafka:3.7.0
        ports:
          - 9092:9092
        env:
          KAFKA_CFG_NODE_ID: '0'
          KAFKA_CFG_PROCESS_ROLES: controller,broker
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@localhost:9093
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
          KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: 'true'
        options: >-
          --health-cmd "nc -z localhost 9092"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

      # Pulsar standalone
      pulsar:
        image: apachepulsar/pulsar:3.2.3
        ports:
          - 6650:6650
          - 8080:8080
        options: >-
          --health-cmd "curl -sf http://localhost:8080/admin/v2/brokers/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 12
          --health-start-period 60s

    env:
      XKIT_REDIS_ADDR: localhost:6379
      XKIT_MONGO_URI: mongodb://localhost:27017
      XKIT_CLICKHOUSE_ADDR: localhost:9000
      XKIT_KAFKA_BROKERS: localhost:9092
      XKIT_PULSAR_URL: pulsar://localhost:6650
      XKIT_ETCD_ENDPOINTS: localhost:2379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Wait for services
        run: |
          echo "等待服务就绪..."
          sleep 10

      - name: Run integration tests
        run: go test -tags=integration -v -race -coverprofile=integration_coverage.out -covermode=atomic ./pkg/...

      - name: Upload integration coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./integration_coverage.out
          flags: integration
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ==================== 工作流 Lint（可选，检查工作流配置）====================
  actionlint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run actionlint
        uses: rhysd/actionlint-action@v1

name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  GO_VERSION: '1.25.7'
  GOLANGCI_LINT_VERSION: 'v2.8.0'

jobs:
  # ==================== 代码质量检查 ====================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false  # 由 golangci-lint-action 管理缓存

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m

      - name: Check go mod tidy
        run: |
          if ! go mod tidy -diff; then
            echo "::error::go mod tidy 检查失败，请运行 'go mod tidy' 并提交更改"
            exit 1
          fi

  # ==================== 单元测试 ====================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Clean build cache
        run: go clean -cache

      - name: Run tests with coverage
        run: go test -v -race -p 2 -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unit
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ==================== 构建验证 ====================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Verify dependencies
        run: go mod verify

      - name: Build
        run: go build -v ./...

  # ==================== 安全扫描 ====================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install librdkafka (for confluent-kafka-go)
        run: |
          sudo apt-get update
          sudo apt-get install -y librdkafka-dev

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  # ==================== 工作流 Lint（可选，检查工作流配置）====================
  # 注意：集成测试已移至本地运行，使用 task kube-up && task kube-test && task kube-down
  actionlint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install and run actionlint
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@latest
          actionlint -color

# Taskfile for XKit
# https://taskfile.dev

version: '3'

vars:
  ARTIFACTS_DIR: .artifacts
  COVERAGE_FILE: .artifacts/coverage.out
  COVERAGE_HTML: .artifacts/coverage.html
  INTEGRATION_COVERAGE_FILE: .artifacts/integration_coverage.out
  INTEGRATION_COVERAGE_HTML: .artifacts/integration_coverage.html
  MIN_COVERAGE: 90
  CORE_MIN_COVERAGE: 95
  FUZZ_TIME: '{{default "30s" .FUZZ_TIME}}'

tasks:
  default:
    desc: æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡
    cmds:
      - task --list

  # ==================== å•å…ƒæµ‹è¯•ä»»åŠ¡ ====================

  test:
    desc: è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
    cmds:
      - go test -v ./...

  test-cover:
    desc: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    cmds:
      - mkdir -p {{.ARTIFACTS_DIR}}
      - go test -v -coverprofile={{.COVERAGE_FILE}} -covermode=atomic ./...
      - go tool cover -html={{.COVERAGE_FILE}} -o {{.COVERAGE_HTML}}
      - 'echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: {{.COVERAGE_HTML}}"'
      - 'echo "æœ€ä½è¦æ±‚: æ•´ä½“ â‰¥{{.MIN_COVERAGE}}%, æ ¸å¿ƒä¸šåŠ¡ â‰¥{{.CORE_MIN_COVERAGE}}%"'

  test-race:
    desc: è¿è¡Œå¹¶å‘ç«äº‰æ£€æµ‹
    cmds:
      - go test -race -v ./...

  test-short:
    desc: è¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•ï¼‰
    cmds:
      - go test -short -v ./...

  test-verbose:
    desc: è¿è¡Œè¯¦ç»†æµ‹è¯•ï¼ˆåŒ…å«æ‰€æœ‰æ—¥å¿—ï¼‰
    cmds:
      - go test -v -count=1 ./...

  # --- æŒ‰æ¨¡å—è¿è¡Œæµ‹è¯• ---

  test-config:
    desc: æµ‹è¯• config æ¨¡å—ï¼ˆxconfï¼‰
    cmds:
      - go test -v ./pkg/config/...

  test-context:
    desc: æµ‹è¯• context æ¨¡å—ï¼ˆxctx, xenv, xplatform, xtenantï¼‰
    cmds:
      - go test -v ./pkg/context/...

  test-distributed:
    desc: æµ‹è¯• distributed æ¨¡å—ï¼ˆxcron, xdlockï¼‰
    cmds:
      - go test -v ./pkg/distributed/...

  test-mq:
    desc: æµ‹è¯• mq æ¨¡å—ï¼ˆxkafka, xpulsarï¼‰
    cmds:
      - go test -v ./pkg/mq/...

  test-observability:
    desc: æµ‹è¯• observability æ¨¡å—ï¼ˆxlog, xmetrics, xrotate, xsampling, xtraceï¼‰
    cmds:
      - go test -v ./pkg/observability/...

  test-resilience:
    desc: æµ‹è¯• resilience æ¨¡å—ï¼ˆxbreaker, xretryï¼‰
    cmds:
      - go test -v ./pkg/resilience/...

  test-storage:
    desc: æµ‹è¯• storage æ¨¡å—ï¼ˆxcache, xclickhouse, xmongoï¼‰
    cmds:
      - go test -v ./pkg/storage/...

  test-util:
    desc: æµ‹è¯• util æ¨¡å—ï¼ˆxfileï¼‰
    cmds:
      - go test -v ./pkg/util/...

  test-internal:
    desc: æµ‹è¯• internal æ¨¡å—ï¼ˆmqcore, e2eï¼‰
    cmds:
      - go test -v ./internal/...

  # ==================== æ€§èƒ½æµ‹è¯•ä»»åŠ¡ ====================

  bench:
    desc: è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./...

  bench-compare:
    desc: å¯¹æ¯”åŸºå‡†æµ‹è¯•ç»“æœï¼ˆéœ€è¦å®‰è£… benchstatï¼‰
    vars:
      OLD: '{{default "old.txt" .OLD}}'
      NEW: '{{default "new.txt" .NEW}}'
    cmds:
      - benchstat {{.OLD}} {{.NEW}}

  # --- æŒ‰æ¨¡å—è¿è¡Œæ€§èƒ½æµ‹è¯• ---

  bench-config:
    desc: è¿è¡Œ config æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/config/...

  bench-context:
    desc: è¿è¡Œ context æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/context/...

  bench-distributed:
    desc: è¿è¡Œ distributed æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/distributed/...

  bench-mq:
    desc: è¿è¡Œ mq æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/mq/...

  bench-observability:
    desc: è¿è¡Œ observability æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/observability/...

  bench-resilience:
    desc: è¿è¡Œ resilience æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/resilience/...

  bench-storage:
    desc: è¿è¡Œ storage æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/storage/...

  bench-util:
    desc: è¿è¡Œ util æ¨¡å—æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/util/...

  # --- æŒ‰åŒ…è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆç»†ç²’åº¦ï¼‰ ---

  bench-xctx:
    desc: è¿è¡Œ xctx åŒ…æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/context/xctx/...

  bench-xlog:
    desc: è¿è¡Œ xlog åŒ…æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/observability/xlog/...

  bench-xcron:
    desc: è¿è¡Œ xcron åŒ…æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/distributed/xcron/...

  bench-xretry:
    desc: è¿è¡Œ xretry åŒ…æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/resilience/xretry/...

  bench-xbreaker:
    desc: è¿è¡Œ xbreaker åŒ…æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/resilience/xbreaker/...

  bench-xcache:
    desc: è¿è¡Œ xcache åŒ…æ€§èƒ½æµ‹è¯•
    cmds:
      - go test -bench=. -benchmem ./pkg/storage/xcache/...

  # ==================== æ¨¡ç³Šæµ‹è¯•ä»»åŠ¡ ====================

  # --- æŒ‰æ¨¡å—è¿è¡Œæ¨¡ç³Šæµ‹è¯• ---

  fuzz-config:
    desc: è¿è¡Œ config æ¨¡å—æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/config/xconf/...

  fuzz-context:
    desc: è¿è¡Œ context/xctx æ¨¡ç³Šæµ‹è¯•
    cmds:
      - echo "è¿è¡Œ xctx æ¨¡ç³Šæµ‹è¯•ï¼ˆDeployï¼‰..."
      - go test -fuzz=FuzzParseDeploymentType -fuzztime={{.FUZZ_TIME}} ./pkg/context/xctx/...
      - echo "è¿è¡Œ xctx æ¨¡ç³Šæµ‹è¯•ï¼ˆTraceï¼‰..."
      - go test -fuzz=FuzzWithTraceID -fuzztime={{.FUZZ_TIME}} ./pkg/context/xctx/...
      - echo "è¿è¡Œ xctx æ¨¡ç³Šæµ‹è¯•ï¼ˆPlatformï¼‰..."
      - go test -fuzz=FuzzWithPlatformID -fuzztime={{.FUZZ_TIME}} ./pkg/context/xctx/...

  fuzz-distributed:
    desc: è¿è¡Œ distributed/xcron æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/distributed/xcron/...

  fuzz-observability:
    desc: è¿è¡Œ observability æ¨¡å—æ¨¡ç³Šæµ‹è¯•
    cmds:
      - echo "è¿è¡Œ xlog æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xlog/...
      - echo "è¿è¡Œ xmetrics æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=FuzzStringAttr -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xmetrics/...
      - echo "è¿è¡Œ xrotate æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=FuzzWrite -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xrotate/...
      - echo "è¿è¡Œ xsampling æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xsampling/...
      - echo "è¿è¡Œ xtrace æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=FuzzTraceInfo_IsEmpty -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xtrace/...

  fuzz-resilience:
    desc: è¿è¡Œ resilience æ¨¡å—æ¨¡ç³Šæµ‹è¯•
    cmds:
      - echo "è¿è¡Œ xbreaker æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=FuzzConsecutiveFailures -fuzztime={{.FUZZ_TIME}} ./pkg/resilience/xbreaker/...
      - echo "è¿è¡Œ xretry æ¨¡ç³Šæµ‹è¯•..."
      - go test -fuzz=FuzzExponentialBackoff_NextDelay -fuzztime={{.FUZZ_TIME}} ./pkg/resilience/xretry/...

  fuzz-storage:
    desc: è¿è¡Œ storage/xcache æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzMemory_SetGet -fuzztime={{.FUZZ_TIME}} ./pkg/storage/xcache/...

  fuzz-util:
    desc: è¿è¡Œ util/xfile æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzSanitizePath -fuzztime={{.FUZZ_TIME}} ./pkg/util/xfile/...

  # --- æŒ‰åŒ…è¿è¡Œæ¨¡ç³Šæµ‹è¯•ï¼ˆç»†ç²’åº¦ï¼‰ ---

  fuzz-xconf:
    desc: è¿è¡Œ xconf æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzNewFromBytes -fuzztime={{.FUZZ_TIME}} ./pkg/config/xconf/...

  fuzz-xctx:
    desc: è¿è¡Œ xctx æ¨¡ç³Šæµ‹è¯•
    cmds:
      - echo "è¿è¡Œ FuzzParseDeploymentType..."
      - go test -fuzz=FuzzParseDeploymentType -fuzztime={{.FUZZ_TIME}} ./pkg/context/xctx/...
      - echo "è¿è¡Œ FuzzWithTraceID..."
      - go test -fuzz=FuzzWithTraceID -fuzztime={{.FUZZ_TIME}} ./pkg/context/xctx/...
      - echo "è¿è¡Œ FuzzWithPlatformID..."
      - go test -fuzz=FuzzWithPlatformID -fuzztime={{.FUZZ_TIME}} ./pkg/context/xctx/...

  fuzz-xtenant:
    desc: è¿è¡Œ xtenant æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/context/xtenant/...

  fuzz-xcron:
    desc: è¿è¡Œ xcron æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/distributed/xcron/...

  fuzz-xlog:
    desc: è¿è¡Œ xlog æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xlog/...

  fuzz-xmetrics:
    desc: è¿è¡Œ xmetrics æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzStringAttr -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xmetrics/...

  fuzz-xrotate:
    desc: è¿è¡Œ xrotate æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzWrite -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xrotate/...

  fuzz-xsampling:
    desc: è¿è¡Œ xsampling æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=. -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xsampling/...

  fuzz-xtrace:
    desc: è¿è¡Œ xtrace æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzTraceInfo_IsEmpty -fuzztime={{.FUZZ_TIME}} ./pkg/observability/xtrace/...

  fuzz-xbreaker:
    desc: è¿è¡Œ xbreaker æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzConsecutiveFailures -fuzztime={{.FUZZ_TIME}} ./pkg/resilience/xbreaker/...

  fuzz-xretry:
    desc: è¿è¡Œ xretry æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzExponentialBackoff_NextDelay -fuzztime={{.FUZZ_TIME}} ./pkg/resilience/xretry/...
      - go test -fuzz=FuzzLinearBackoff_NextDelay -fuzztime={{.FUZZ_TIME}} ./pkg/resilience/xretry/...
      - go test -fuzz=FuzzFixedBackoff_NextDelay -fuzztime={{.FUZZ_TIME}} ./pkg/resilience/xretry/...

  fuzz-xcache:
    desc: è¿è¡Œ xcache æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzMemory_SetGet -fuzztime={{.FUZZ_TIME}} ./pkg/storage/xcache/...

  fuzz-xfile:
    desc: è¿è¡Œ xfile æ¨¡ç³Šæµ‹è¯•
    cmds:
      - go test -fuzz=FuzzSanitizePath -fuzztime={{.FUZZ_TIME}} ./pkg/util/xfile/...

  # ==================== ä»£ç è´¨é‡ä»»åŠ¡ ====================

  lint:
    desc: è¿è¡Œ golangci-lint æ£€æŸ¥
    cmds:
      - golangci-lint run ./...

  lint-fix:
    desc: è¿è¡Œ golangci-lint å¹¶è‡ªåŠ¨ä¿®å¤
    cmds:
      - golangci-lint run --fix ./...

  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - golangci-lint fmt

  fmt-check:
    desc: æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆä¸ä¿®æ”¹æ–‡ä»¶ï¼‰
    cmds:
      - gofmt -l .
      - test -z "$(gofmt -l .)"

  vet:
    desc: è¿è¡Œ go vet æ£€æŸ¥
    cmds:
      - go vet ./...

  gocyclo:
    desc: è¿è¡Œåœˆå¤æ‚åº¦æ£€æŸ¥
    cmds:
      - gocyclo -over 10 internal/ pkg/

  vulncheck:
    desc: è¿è¡Œå®‰å…¨æ¼æ´æ‰«æ
    cmds:
      - go run golang.org/x/vuln/cmd/govulncheck@latest ./...

  # ==================== ç»¼åˆæ£€æŸ¥ä»»åŠ¡ ====================

  check:
    desc: è¿è¡Œæ‰€æœ‰æ£€æŸ¥ï¼ˆlint + test + test-raceï¼‰
    cmds:
      - task: lint
      - task: gocyclo
      - task: test
      - task: test-race
      - task: vulncheck

  pre-commit:
    desc: æäº¤å‰æ£€æŸ¥ï¼ˆå¿«é€Ÿæ£€æŸ¥ç‰ˆæœ¬ï¼‰
    cmds:
      - task: fmt-check
      - task: lint
      - task: test-short
      - task: worktree-check

  ci:
    desc: CI æµæ°´çº¿æ£€æŸ¥ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
    cmds:
      - task: fmt-check
      - task: lint
      - task: gocyclo
      - task: test-cover
      - task: test-race
      - task: vulncheck

  # ==================== ä¾èµ–ç®¡ç†ä»»åŠ¡ ====================

  deps:
    desc: ä¸‹è½½å¹¶æ•´ç†ä¾èµ–
    cmds:
      - go mod download
      - go mod tidy
      - go mod verify

  deps-update:
    desc: æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
    cmds:
      - go get -u ./...
      - go mod tidy

  deps-graph:
    desc: æŸ¥çœ‹ä¾èµ–å…³ç³»å›¾
    cmds:
      - go mod graph

  # ==================== æ¸…ç†ä»»åŠ¡ ====================

  clean:
    desc: æ¸…ç†æ„å»ºäº§ç‰©å’Œä¸´æ—¶æ–‡ä»¶
    cmds:
      - rm -rf {{.ARTIFACTS_DIR}}
      - go clean -cache -testcache -modcache

  clean-test:
    desc: æ¸…ç†æµ‹è¯•ç¼“å­˜
    cmds:
      - go clean -testcache

  # ==================== å¼€å‘è¾…åŠ©ä»»åŠ¡ ====================

  version:
    desc: æ˜¾ç¤º Go ç‰ˆæœ¬ä¿¡æ¯
    cmds:
      - go version
      - go env GOVERSION

  verify:
    desc: éªŒè¯é¡¹ç›®é…ç½®
    cmds:
      - echo "éªŒè¯ Go ç‰ˆæœ¬..."
      - 'go version | grep "go1.25.4" || (echo "é”™è¯¯: éœ€è¦ Go 1.25.4" && exit 1)'
      - echo "éªŒè¯ golangci-lint é…ç½®..."
      - golangci-lint config verify
      - echo "éªŒè¯ Go æ¨¡å—..."
      - go mod verify
      - echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡"

  init-hooks:
    desc: åˆå§‹åŒ– Git hooks
    cmds:
      - echo "é…ç½® Git hooks..."
      - git config core.hooksPath .githooks
      - mkdir -p .githooks
      - echo "âœ… Git hooks å·²é…ç½®"

  # ==================== E2E æµ‹è¯•ä»»åŠ¡ ====================

  e2e-test:
    desc: è¿è¡Œ E2E æµ‹è¯•ï¼ˆxctx+xtrace+xlog+xtenantï¼‰
    cmds:
      - go test -tags=e2e -v ./internal/e2e/...

  # ==================== é›†æˆæµ‹è¯•ä»»åŠ¡ï¼ˆtestcontainers æ–¹å¼ï¼‰====================

  integration-test:
    desc: è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆéœ€è¦ Redis/Mongo/ClickHouseï¼‰
    cmds:
      - go test -tags=integration -v ./pkg/...

  integration-test-storage:
    desc: è¿è¡Œ storage æ¨¡å—é›†æˆæµ‹è¯•
    cmds:
      - go test -tags=integration -v ./pkg/storage/...

  integration-test-distributed:
    desc: è¿è¡Œ distributed æ¨¡å—é›†æˆæµ‹è¯•
    cmds:
      - go test -tags=integration -v ./pkg/distributed/...

  integration-kafka-start:
    desc: å¯åŠ¨ Kafka å®¹å™¨ï¼ˆç”¨äºé›†æˆæµ‹è¯•ï¼‰
    vars:
      KAFKA_CONTAINER: xkit-kafka-test
    cmds:
      - |
        if podman ps -a --format '{{`{{.Names}}`}}' | grep -q {{.KAFKA_CONTAINER}}; then
          echo "å®¹å™¨ {{.KAFKA_CONTAINER}} å·²å­˜åœ¨ï¼Œæ­£åœ¨å¯åŠ¨..."
          podman start {{.KAFKA_CONTAINER}}
        else
          echo "åˆ›å»º Kafka å®¹å™¨..."
          podman run -d --name {{.KAFKA_CONTAINER}} \
            -p 9092:9092 \
            -e KAFKA_CFG_NODE_ID=0 \
            -e KAFKA_CFG_PROCESS_ROLES=controller,broker \
            -e KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093 \
            -e KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT \
            -e KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@localhost:9093 \
            -e KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER \
            -e KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
            docker.io/bitnami/kafka:latest
        fi
      - echo "ç­‰å¾… Kafka å¯åŠ¨..."
      - sleep 10
      - 'echo "âœ… Kafka å·²å¯åŠ¨åœ¨ localhost:9092"'

  integration-kafka-stop:
    desc: åœæ­¢ Kafka å®¹å™¨
    vars:
      KAFKA_CONTAINER: xkit-kafka-test
    cmds:
      - podman stop {{.KAFKA_CONTAINER}} || true
      - echo "âœ… Kafka å®¹å™¨å·²åœæ­¢"

  integration-kafka-rm:
    desc: åˆ é™¤ Kafka å®¹å™¨
    vars:
      KAFKA_CONTAINER: xkit-kafka-test
    cmds:
      - podman rm -f {{.KAFKA_CONTAINER}} || true
      - echo "âœ… Kafka å®¹å™¨å·²åˆ é™¤"

  integration-pulsar-start:
    desc: å¯åŠ¨ Pulsar å®¹å™¨ï¼ˆç”¨äºé›†æˆæµ‹è¯•ï¼‰
    vars:
      PULSAR_CONTAINER: xkit-pulsar-test
    cmds:
      - |
        if podman ps -a --format '{{`{{.Names}}`}}' | grep -q {{.PULSAR_CONTAINER}}; then
          echo "å®¹å™¨ {{.PULSAR_CONTAINER}} å·²å­˜åœ¨ï¼Œæ­£åœ¨å¯åŠ¨..."
          podman start {{.PULSAR_CONTAINER}}
        else
          echo "åˆ›å»º Pulsar å®¹å™¨..."
          podman run -d --name {{.PULSAR_CONTAINER}} \
            -p 6650:6650 \
            -p 8080:8080 \
            docker.io/apachepulsar/pulsar:latest \
            bin/pulsar standalone
        fi
      - echo "ç­‰å¾… Pulsar å¯åŠ¨..."
      - sleep 15
      - 'echo "âœ… Pulsar å·²å¯åŠ¨åœ¨ localhost:6650"'

  integration-pulsar-stop:
    desc: åœæ­¢ Pulsar å®¹å™¨
    vars:
      PULSAR_CONTAINER: xkit-pulsar-test
    cmds:
      - podman stop {{.PULSAR_CONTAINER}} || true
      - echo "âœ… Pulsar å®¹å™¨å·²åœæ­¢"

  integration-pulsar-rm:
    desc: åˆ é™¤ Pulsar å®¹å™¨
    vars:
      PULSAR_CONTAINER: xkit-pulsar-test
    cmds:
      - podman rm -f {{.PULSAR_CONTAINER}} || true
      - echo "âœ… Pulsar å®¹å™¨å·²åˆ é™¤"

  integration-start:
    desc: å¯åŠ¨æ‰€æœ‰é›†æˆæµ‹è¯•å®¹å™¨
    cmds:
      - task: integration-kafka-start
      - task: integration-pulsar-start
      - echo "âœ… æ‰€æœ‰é›†æˆæµ‹è¯•å®¹å™¨å·²å¯åŠ¨"

  integration-stop:
    desc: åœæ­¢æ‰€æœ‰é›†æˆæµ‹è¯•å®¹å™¨
    cmds:
      - task: integration-kafka-stop
      - task: integration-pulsar-stop
      - echo "âœ… æ‰€æœ‰é›†æˆæµ‹è¯•å®¹å™¨å·²åœæ­¢"

  integration-clean:
    desc: æ¸…ç†æ‰€æœ‰é›†æˆæµ‹è¯•å®¹å™¨
    cmds:
      - task: integration-kafka-rm
      - task: integration-pulsar-rm
      - echo "âœ… æ‰€æœ‰é›†æˆæµ‹è¯•å®¹å™¨å·²æ¸…ç†"

  integration-run:
    desc: å¯åŠ¨å®¹å™¨å¹¶è¿è¡Œé›†æˆæµ‹è¯•
    cmds:
      - task: integration-start
      - task: integration-test
      - task: integration-stop

  integration-cover:
    desc: è¿è¡Œé›†æˆæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    cmds:
      - task: integration-start
      - mkdir -p {{.ARTIFACTS_DIR}}
      - go test -tags=integration -v -coverprofile={{.INTEGRATION_COVERAGE_FILE}} ./pkg/mq/... ./pkg/storage/... ./pkg/distributed/...
      - go tool cover -html={{.INTEGRATION_COVERAGE_FILE}} -o {{.INTEGRATION_COVERAGE_HTML}}
      - task: integration-stop
      - 'echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: {{.INTEGRATION_COVERAGE_HTML}}"'

  # ==================== Kube-Play é›†æˆæµ‹è¯•ç¯å¢ƒï¼ˆæ¨èç”¨äºæœ¬åœ°å¼€å‘ï¼‰====================

  kube-up:
    desc: å¯åŠ¨æ‰€æœ‰é›†æˆæµ‹è¯•æœåŠ¡ï¼ˆRedis/Mongo/ClickHouse/Kafka/Pulsar/etcdï¼‰
    vars:
      KUBE_FILE: deploy/integration/xkit-integration.yaml
    cmds:
      - echo "ğŸš€ å¯åŠ¨ XKit é›†æˆæµ‹è¯•ç¯å¢ƒ..."
      - podman kube play {{.KUBE_FILE}}
      - echo ""
      - echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
      - sleep 15
      - task: kube-status
      - echo ""
      - echo "âœ… é›†æˆæµ‹è¯•ç¯å¢ƒå·²å°±ç»ªï¼"
      - echo ""
      - echo "ğŸ’¡ è®¾ç½®ç¯å¢ƒå˜é‡åè¿è¡Œæµ‹è¯•:"
      - echo "   source deploy/integration/env.sh && task integration-test"

  kube-down:
    desc: åœæ­¢å¹¶æ¸…ç†æ‰€æœ‰é›†æˆæµ‹è¯•æœåŠ¡
    vars:
      KUBE_FILE: deploy/integration/xkit-integration.yaml
    cmds:
      - echo "ğŸ›‘ åœæ­¢ XKit é›†æˆæµ‹è¯•ç¯å¢ƒ..."
      - podman kube play --down {{.KUBE_FILE}} || true
      - echo "âœ… é›†æˆæµ‹è¯•ç¯å¢ƒå·²åœæ­¢"

  kube-status:
    desc: æŸ¥çœ‹é›†æˆæµ‹è¯•æœåŠ¡çŠ¶æ€
    cmds:
      - echo "ğŸ“Š XKit é›†æˆæµ‹è¯•æœåŠ¡çŠ¶æ€:"
      - echo ""
      - podman pod ps --filter label=app=xkit-integration --format "table {{`{{.Name}}`}}\t{{`{{.Status}}`}}\t{{`{{.Created}}`}}"
      - echo ""
      - echo "ğŸ“¦ å®¹å™¨çŠ¶æ€:"
      - podman ps --filter label=app=xkit-integration --format "table {{`{{.Names}}`}}\t{{`{{.Status}}`}}\t{{`{{.Ports}}`}}"

  kube-logs:
    desc: æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„æ—¥å¿—ï¼ˆSERVICE=redis|mongo|clickhouse|kafka|pulsar|etcdï¼‰
    vars:
      SERVICE: '{{default "redis" .SERVICE}}'
    cmds:
      - podman logs xkit-{{.SERVICE}}-{{.SERVICE}} --tail 100

  kube-restart:
    desc: é‡å¯é›†æˆæµ‹è¯•ç¯å¢ƒ
    cmds:
      - task: kube-down
      - sleep 2
      - task: kube-up

  kube-test:
    desc: ä½¿ç”¨ kube-play ç¯å¢ƒè¿è¡Œé›†æˆæµ‹è¯•ï¼ˆæœåŠ¡å¸¸é©»ï¼Œæµ‹è¯•æ›´å¿«ï¼‰
    env:
      XKIT_REDIS_ADDR: localhost:6379
      XKIT_MONGO_URI: mongodb://localhost:27017
      XKIT_CLICKHOUSE_ADDR: localhost:9000
      XKIT_KAFKA_BROKERS: localhost:9092
      XKIT_PULSAR_URL: pulsar://localhost:6650
      XKIT_ETCD_ENDPOINTS: localhost:2379
    cmds:
      - echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆä½¿ç”¨é¢„å¯åŠ¨çš„æœåŠ¡ï¼‰..."
      - go test -tags=integration -v ./pkg/...

  kube-run:
    desc: ä¸€é”®å¯åŠ¨ç¯å¢ƒå¹¶è¿è¡Œé›†æˆæµ‹è¯•
    cmds:
      - task: kube-up
      - task: kube-test
      - 'echo ""'
      - 'echo "ğŸ’¡ æœåŠ¡ä»åœ¨è¿è¡Œï¼Œå¯åå¤æ‰§è¡Œ: task kube-test"'
      - 'echo "   åœæ­¢æœåŠ¡: task kube-down"'

  # ==================== å·¥ä½œåŒºæ£€æŸ¥ ====================

  worktree-check:
    desc: æ£€æŸ¥å·¥ä½œåŒºæ— æœªæš‚å­˜å˜æ›´æˆ–æœªè·Ÿè¸ªæ–‡ä»¶
    cmds:
      - 'test -z "$(git diff --name-only)" || (echo "é”™è¯¯: å·¥ä½œåŒºå­˜åœ¨æœªæš‚å­˜å˜æ›´" && git diff --name-only && exit 1)'
      - 'test -z "$(git ls-files --others --exclude-standard)" || (echo "é”™è¯¯: å­˜åœ¨æœªè·Ÿè¸ªæ–‡ä»¶" && git ls-files --others --exclude-standard && exit 1)'

  # ==================== å¸®åŠ©ä¿¡æ¯ ====================

  help:
    desc: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    cmds:
      - echo "XKit å¼€å‘ä»»åŠ¡"
      - echo ""
      - 'echo "ğŸ“¦ æ¨¡å—ç»“æ„:"'
      - echo "  pkg/config/       - é…ç½®ç®¡ç†ï¼ˆxconfï¼‰"
      - echo "  pkg/context/      - ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆxctx, xenv, xplatform, xtenantï¼‰"
      - echo "  pkg/distributed/  - åˆ†å¸ƒå¼ï¼ˆxcron, xdlockï¼‰"
      - echo "  pkg/mq/           - æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆxkafka, xpulsarï¼‰"
      - echo "  pkg/observability/- å¯è§‚æµ‹æ€§ï¼ˆxlog, xmetrics, xrotate, xsampling, xtraceï¼‰"
      - echo "  pkg/resilience/   - å¼¹æ€§èƒ½åŠ›ï¼ˆxbreaker, xretryï¼‰"
      - echo "  pkg/storage/      - å­˜å‚¨ï¼ˆxcache, xclickhouse, xmongoï¼‰"
      - echo "  pkg/util/         - å·¥å…·ï¼ˆxfileï¼‰"
      - echo ""
      - 'echo "ğŸ§ª å¸¸ç”¨æµ‹è¯•ä»»åŠ¡:"'
      - echo "  task test              - è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•"
      - echo "  task test-race         - å¹¶å‘ç«äº‰æ£€æµ‹"
      - echo "  task test-<module>     - æŒ‰æ¨¡å—æµ‹è¯•ï¼ˆå¦‚ test-contextï¼‰"
      - echo ""
      - 'echo "ğŸ“Š æ€§èƒ½æµ‹è¯•:"'
      - echo "  task bench             - è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•"
      - echo "  task bench-<module>    - æŒ‰æ¨¡å—æµ‹è¯•ï¼ˆå¦‚ bench-observabilityï¼‰"
      - echo "  task bench-<pkg>       - æŒ‰åŒ…æµ‹è¯•ï¼ˆå¦‚ bench-xctxï¼‰"
      - echo ""
      - 'echo "ğŸ”¬ æ¨¡ç³Šæµ‹è¯•:"'
      - echo "  task fuzz-<module>     - æŒ‰æ¨¡å—æµ‹è¯•ï¼ˆå¦‚ fuzz-resilienceï¼‰"
      - echo "  task fuzz-<pkg>        - æŒ‰åŒ…æµ‹è¯•ï¼ˆå¦‚ fuzz-xretryï¼‰"
      - echo "  FUZZ_TIME=60s task fuzz-xctx  - è‡ªå®šä¹‰æ—¶é•¿"
      - echo ""
      - 'echo "ğŸ” ä»£ç è´¨é‡:"'
      - echo "  task lint              - ä»£ç æ£€æŸ¥"
      - echo "  task lint-fix          - è‡ªåŠ¨ä¿®å¤"
      - echo "  task check             - å®Œæ•´æ£€æŸ¥"
      - echo "  task pre-commit        - æäº¤å‰æ£€æŸ¥"
      - echo ""
      - 'echo "ğŸ³ é›†æˆæµ‹è¯•ï¼ˆtestcontainersï¼‰:"'
      - echo "  task integration-start - å¯åŠ¨ Kafka/Pulsar å®¹å™¨"
      - echo "  task integration-test  - è¿è¡Œé›†æˆæµ‹è¯•"
      - echo "  task integration-stop  - åœæ­¢å®¹å™¨"
      - echo "  task integration-run   - ä¸€é”®è¿è¡Œé›†æˆæµ‹è¯•"
      - echo ""
      - 'echo "â˜¸ï¸  é›†æˆæµ‹è¯•ï¼ˆkube-playï¼Œæ¨èæœ¬åœ°å¼€å‘ï¼‰:"'
      - echo "  task kube-up           - å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆ6ä¸ªï¼‰"
      - echo "  task kube-test         - è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆç§’çº§ï¼‰"
      - echo "  task kube-down         - åœæ­¢æ‰€æœ‰æœåŠ¡"
      - echo "  task kube-run          - ä¸€é”®å¯åŠ¨å¹¶æµ‹è¯•"
      - echo "  task kube-status       - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
      - echo "  task kube-logs SERVICE=kafka - æŸ¥çœ‹æ—¥å¿—"
      - echo ""
      - 'echo "ğŸ“ è¯¦ç»†ä»»åŠ¡åˆ—è¡¨: task --list"'

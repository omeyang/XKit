# XKit 集成测试环境 - Kubernetes YAML for podman kube play
# 使用方法: podman kube play deploy/integration/xkit-integration.yaml
# 停止方法: podman kube play --down deploy/integration/xkit-integration.yaml
#
# 服务端口映射:
#   Redis:      6379
#   MongoDB:    27017
#   ClickHouse: 9000 (native), 8123 (http)
#   Kafka:      9092
#   Pulsar:     6650 (service), 8080 (http)
#   etcd:       2379 (client)
---
apiVersion: v1
kind: Pod
metadata:
  name: xkit-redis
  labels:
    app: xkit-integration
    service: redis
spec:
  containers:
    - name: redis
      image: docker.io/redis:7.2-alpine
      ports:
        - containerPort: 6379
          hostPort: 6379
      resources:
        limits:
          memory: "256Mi"
          cpu: "500m"
      readinessProbe:
        exec:
          command: ["redis-cli", "ping"]
        initialDelaySeconds: 5
        periodSeconds: 5
---
apiVersion: v1
kind: Pod
metadata:
  name: xkit-mongo
  labels:
    app: xkit-integration
    service: mongodb
spec:
  containers:
    - name: mongodb
      image: docker.io/mongo:7.0
      ports:
        - containerPort: 27017
          hostPort: 27017
      resources:
        limits:
          memory: "512Mi"
          cpu: "500m"
      readinessProbe:
        exec:
          command: ["mongosh", "--eval", "db.adminCommand('ping')"]
        initialDelaySeconds: 10
        periodSeconds: 10
---
apiVersion: v1
kind: Pod
metadata:
  name: xkit-clickhouse
  labels:
    app: xkit-integration
    service: clickhouse
spec:
  containers:
    - name: clickhouse
      image: docker.io/clickhouse/clickhouse-server:23.12
      ports:
        - containerPort: 9000
          hostPort: 9000
        - containerPort: 8123
          hostPort: 8123
      env:
        - name: CLICKHOUSE_USER
          value: "default"
        - name: CLICKHOUSE_PASSWORD
          value: ""
        - name: CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT
          value: "1"
      resources:
        limits:
          memory: "1Gi"
          cpu: "1000m"
      readinessProbe:
        httpGet:
          path: /ping
          port: 8123
        initialDelaySeconds: 10
        periodSeconds: 5
---
apiVersion: v1
kind: Pod
metadata:
  name: xkit-kafka
  labels:
    app: xkit-integration
    service: kafka
spec:
  containers:
    - name: kafka
      image: docker.io/apache/kafka:3.7.0
      ports:
        - containerPort: 9092
          hostPort: 9092
      env:
        # KRaft 模式（无需 Zookeeper）
        - name: KAFKA_CFG_NODE_ID
          value: "0"
        - name: KAFKA_CFG_PROCESS_ROLES
          value: "controller,broker"
        - name: KAFKA_CFG_LISTENERS
          value: "PLAINTEXT://:9092,CONTROLLER://:9093"
        - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
          value: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
        - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
          value: "0@localhost:9093"
        - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
          value: "CONTROLLER"
        - name: KAFKA_CFG_ADVERTISED_LISTENERS
          value: "PLAINTEXT://localhost:9092"
        # 自动创建 topic
        - name: KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE
          value: "true"
      resources:
        limits:
          memory: "1Gi"
          cpu: "1000m"
      readinessProbe:
        tcpSocket:
          port: 9092
        initialDelaySeconds: 30
        periodSeconds: 10
---
apiVersion: v1
kind: Pod
metadata:
  name: xkit-pulsar
  labels:
    app: xkit-integration
    service: pulsar
spec:
  containers:
    - name: pulsar
      image: docker.io/apachepulsar/pulsar:3.2.3
      command: ["bin/pulsar", "standalone"]
      ports:
        - containerPort: 6650
          hostPort: 6650
        - containerPort: 8080
          hostPort: 18080  # 避免与 ClickHouse 冲突
      resources:
        limits:
          memory: "1Gi"
          cpu: "1000m"
      readinessProbe:
        httpGet:
          path: /admin/v2/brokers/health
          port: 8080
        initialDelaySeconds: 60
        periodSeconds: 10
        timeoutSeconds: 5
---
apiVersion: v1
kind: Pod
metadata:
  name: xkit-etcd
  labels:
    app: xkit-integration
    service: etcd
spec:
  containers:
    - name: etcd
      image: quay.io/coreos/etcd:v3.5.17
      command:
        - etcd
        - --name=etcd0
        - --advertise-client-urls=http://0.0.0.0:2379
        - --listen-client-urls=http://0.0.0.0:2379
        - --initial-advertise-peer-urls=http://0.0.0.0:2380
        - --listen-peer-urls=http://0.0.0.0:2380
        - --initial-cluster=etcd0=http://0.0.0.0:2380
      ports:
        - containerPort: 2379
          hostPort: 2379
      resources:
        limits:
          memory: "256Mi"
          cpu: "500m"
      readinessProbe:
        exec:
          command: ["etcdctl", "endpoint", "health"]
        initialDelaySeconds: 10
        periodSeconds: 10
